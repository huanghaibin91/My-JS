<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Fetch</title>
</head>

<body>
    <!-- script -->
    <script>
        // Fetch API是一种新规范，用来取代XMLHttpRequest对象。它主要有两个特点，一是接口合理化，Ajax是将所有不同性质的
        // 接口都放在XHR对象上，而Fetch是将它们分散在几个不同的对象上，设计更合理；二是Fetch操作返回Promise对象，
        // 避免了嵌套的回调函数

        // 检查浏览器是否部署了Fetch API
        if ("fetch" in window) {
            // 支持 
        } else {
            // 不支持 
        }

        // Fetch API的简单例子
        fetch(url).then(function (response) {
            return response.json();
        }).then(function (jsonData) {
            console.log(jsonData);
        }).catch(function () {
            console.log('出错了');
        });
        // Ajax写法
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.responseType = 'json';
        xhr.onload = function () {
            console.log(xhr.response);
        };
        xhr.onerror = function () {
            console.log('出错了');
        };
        xhr.send();

        // Fetch API最大的特点是，除了返回Promise对象，还有一点就是数据传送是以数据流（stream）的形式进行的。
        // 对于大文件，数据是一段一段得到的
        // Fetch API提供以下五个数据流读取器：.text()：返回字符串，.json()：返回一个JSON对象，.formData()：返回一个FormData对象
        // .blob()：返回一个blob对象，.arrayBuffer()：返回一个二进制数组

        // fetch方法的第一个参数可以是URL字符串，也可以是后文要讲到的Request对象实例
        // Fetch方法返回一个Promise对象，并将一个response对象传给回调函数
        fetch('./api/some.json').then(function (response) {
            if (response.ok) { // response对象有一个ok属性，如果返回的状态码在200到299之间（即请求成功），这个属性为true，否则为false
                response.json().then(function (data) {
                    console.log(data);
                });
            } else {
                console.log('请求失败，状态码为', response.status);
            }
        }, function (err) {
            console.log('出错：', err);
        });
        // response对象除了json方法，还包含了服务器HTTP回应的元数据
        fetch('users.json').then(function (response) {
            console.log(response.headers.get('Content-Type'));
            console.log(response.headers.get('Date'));
            console.log(response.status);
            console.log(response.statusText);
            console.log(response.type); // response.type属性比较特别，表示HTTP回应的类型，它有以下三个值
            // basic：正常的同域请求，cors：CORS机制下的跨域请求，opaque：非CORS机制下的跨域请求，这时无法读取返回的数据，也无法判断是否请求成功
            console.log(response.url);
        });
        // 需要在CORS机制下发出跨域请求，需要指明状态
        fetch('http://some-site.com/cors-enabled/some.json', {mode: 'cors'})
        // fetch方法的第二个参数还可以用来配置其他值，比如指定cookie连同HTTP请求一起发出
    </script>
</body>

</html>